trigger:
  paths:
    include:
      - terraform/infrastructure/**
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: 'devops-config'
  - name: S3_BUCKET_NAME
    value: 'backend-s3-final-project'

parameters:
  - name: action
    displayName: 'Action'
    type: string
    default: 'apply'
    values:
      - apply
      - destroy

steps:
  - task: TerraformInstaller@1
    inputs:
      terraformVersion: '1.5.7'

  - task: TerraformTaskV4@4
    displayName: 'Terraform Init'
    inputs:
      provider: 'aws'
      command: 'init'
      workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/infrastructure'
      backendServiceAWS: 'aws-terraform-connection'
      backendAWSBucketName: '$(S3_BUCKET_NAME)'
      backendAWSKey: 'infra/terraform.tfstate'
      backendAWSRegion: 'us-east-1'

  - task: TerraformTaskV4@4
    displayName: 'Terraform Validate'
    inputs:
      provider: 'aws'
      command: 'validate'
      workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/infrastructure'
      environmentServiceNameAWS: 'aws-terraform-connection'

  - ${{ if eq(parameters.action, 'destroy') }}:
    - script: |
        aws eks update-kubeconfig --name devops-cluster --region us-east-1 || true
        kubectl delete ingress --all-namespaces --all --timeout=60s || true
        kubectl delete targetgroupbindings -A --all --timeout=60s || true
        kubectl delete secret app-secrets -n default --ignore-not-found=true || true
        kubectl delete secret nexus-registry-secret -n default --ignore-not-found=true || true
      displayName: 'Pre-destroy Cleanup'

  - task: TerraformTaskV4@4
    displayName: 'Terraform ${{ parameters.action }}'
    inputs:
      provider: 'aws'
      command: '${{ parameters.action }}'
      workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/infrastructure'
      commandOptions: '-auto-approve -var="vault_address=$(vault-address)" -var="vault_token=$(vault-token)"'
      environmentServiceNameAWS: 'aws-terraform-connection'
